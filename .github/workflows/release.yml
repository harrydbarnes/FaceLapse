name: Release

on:
  push:
    branches: [ "main" ]
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  version-bump:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    outputs:
      new_tag: ${{ steps.bump.outputs.new_tag }}
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine Next Version
        id: bump
        run: |
          # Get latest tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          IFS='.' read -r major minor patch <<< "${LATEST_TAG#v}"

          # Check commit messages
          BUMP_MAJOR=false
          BUMP_MINOR=false
          BUMP_PATCH=false

          if [ "$LATEST_TAG" = "v0.0.0" ]; then
            commits=$(git log --pretty=format:"%s")
          else
            commits=$(git log $LATEST_TAG..HEAD --pretty=format:"%s")
          fi

          if echo "$commits" | grep -q "breaking"; then
            BUMP_MAJOR=true
          elif echo "$commits" | grep -q "feat"; then
            BUMP_MINOR=true
          else
            BUMP_PATCH=true
          fi

          if [ "$BUMP_MAJOR" = true ]; then
            major=$((major + 1))
            minor=0
            patch=0
          elif [ "$BUMP_MINOR" = true ]; then
            minor=$((minor + 1))
            patch=0
          else
            patch=$((patch + 1))
          fi

          NEW_TAG="v$major.$minor.$patch"
          echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT
          echo "Determined new version: $NEW_TAG"

      - name: Push Tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag ${{ steps.bump.outputs.new_tag }}
          git push origin ${{ steps.bump.outputs.new_tag }}

  release:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    # In a real app, we would decode the keystore from secrets here.
    # For this task, we will build an unsigned release or debug APK if signing is not set up.
    # We'll assume we want to produce the artifact.

    - name: Build APKs
      run: ./gradlew assembleRelease assembleDebug

    - name: Generate Release Notes
      id: release_notes
      run: |
        # Simple changelog generation based on commits since last tag
        LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        if [ -z "$LAST_TAG" ]; then
          git log --pretty=format:"- %s" > RELEASE_NOTES.md
        else
          git log --pretty=format:"- %s" "$LAST_TAG"..HEAD > RELEASE_NOTES.md
        fi

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        body_path: RELEASE_NOTES.md
        files: |
          app/build/outputs/apk/release/*.apk
          app/build/outputs/apk/debug/*.apk
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
